<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaced Repetition Planner v2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f4f7f6;
            display: grid;
            place-items: center;
            min-height: 90vh;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 500px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; /* Important for padding */
            background-color: #fff; /* for select on dark mode */
        }
        button {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 700;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 1rem;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Study Schedule Generator</h1>
        
        <div class="form-group">
            <label for="topic">What topic are you learning?</label>
            <input type="text" id="topic" placeholder="e.g., Python OOP">
        </div>

        <div class="form-group">
            <label for="startDate">When did you study it?</label>
            <input type="date" id="startDate">
        </div>

        <div class="form-group">
            <label for="schedule">Repetition Schedule (Intervals in Days)</label>
            <select id="schedule">
                <option value="1,3,7,14,30,60,90,120,180,365">Aggressive (For Exams: 1,3,7,14,30,60,90,120,180,365)</option>
                <option value="1,7,30,90,120,180,270,365">Long-Term (For Concepts: 1,7,30,90,120,180,270,365)</option>
                <option value="1,2,4,8,16,32,64,128,160,240,360">Rapid Growth (Ebbinghaus: 1,2,4,8,16,32,64,128,160,240,360)</option>
                <option value="1,3,7,15,30,60,120,240,360" selected>Your Original (1,3,7,15,30,60,120,240,360)</option>
            </select>
        </div>

        <button id="generateBtn">Generate .ics File</button>

    </div>

    <script>
        // Set the default date to today
        document.getElementById('startDate').valueAsDate = new Date();

        // Attach event listener to the button
        document.getElementById('generateBtn').addEventListener('click', generateICS);

        /**
         * Formats a Date object into 'YYYYMMDDTHHMMSSZ' UTC format.
         * This is required for DTSTAMP.
         */
        function formatUTC(date) {
            return date.toISOString().replace(/[-:.]/g, '').substring(0, 15) + 'Z';
        }

        /**
         * Formats a Date object into 'YYYYMMDD' for all-day events.
         */
        function formatDateAllDay(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        /**
         * Main function to generate the ICS content and trigger download.
         */
        function generateICS() {
            const topic = document.getElementById('topic').value;
            const startDateValue = document.getElementById('startDate').value;
            const scheduleValue = document.getElementById('schedule').value;

            // Validation
            if (!topic || !startDateValue) {
                alert('Please fill in both the topic and the start date.');
                return;
            }

            const intervals = scheduleValue.split(',').map(Number);
            const startDate = new Date(startDateValue + 'T00:00:00');
            
            // We need one creation timestamp for all events, in UTC.
            const nowStamp = formatUTC(new Date());
            const uniqueAppID = "spaced-rep-gen-" + Date.now();
            let icsEvents = [];

            intervals.forEach((days, index) => {
                let reviewDate = new Date(startDate.getTime());
                reviewDate.setDate(reviewDate.getDate() + days);

                // For all-day events, DTEND must be the day *after* DTSTART
                let nextDay = new Date(reviewDate.getTime());
                nextDay.setDate(nextDay.getDate() + 1);

                const event = [
                    'BEGIN:VEVENT',
                    'UID:' + uniqueAppID + '-' + index + '@spaced-rep-gen.com', // More robust UID
                    'DTSTAMP:' + nowStamp, // Universal creation time
                    'DTSTART;VALUE=DATE:' + formatDateAllDay(reviewDate),
                    'DTEND;VALUE=DATE:' + formatDateAllDay(nextDay),
                    'SUMMARY:Review #' + (index + 1) + ': ' + topic,
                    'DESCRIPTION:Spaced repetition review for "' + topic + '".\\nThis is review #' + (index + 1) + ' of ' + intervals.length + ' (' + days + ' days).\\nOriginal study date: ' + startDate.toLocaleDateString(),
                    'TRANSP:TRANSPARENT', // Shows as "Free"
                    
                    // --- THIS IS THE CRITICAL FIX FOR IPHONE ---
                    // Alarms for all-day events must be relative to the START
                    // This creates a reminder at 9:00 AM on the day of the event.
                    'BEGIN:VALARM',
                    'ACTION:DISPLAY',
                    'DESCRIPTION:Time to review ' + topic,
                    'TRIGGER;RELATED=START:PT9H', // 9 hours after 00:00 (i.e., 9:00 AM)
                    'END:VALARM',
                    // --- END OF FIX ---

                    'END:VEVENT'
                ].join('\r\n'); // \r\n is the required line ending

                icsEvents.push(event);
            });

            // Create the full calendar file content
            const icsFileContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//SpacedRepApp/v2.0//EN',
                ...icsEvents,
                'END:VCALENDAR'
            ].join('\r\n');

            // Trigger the download
            download(topic.replace(/[^a-z0-9]/gi, '_') + '_schedule.ics', icsFileContent);
        }
        
        /**
         * Triggers a browser download of a text file.
         */
        function download(filename, text) {
            const element = document.createElement('a');
            // Use 'text/calendar' for the MIME type
            element.setAttribute('href', 'data:text/calendar;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

    </script>
</body>
</html>
