<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaced Repetition Planner v4</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f4f7f6;
            display: grid;
            place-items: center;
            min-height: 90vh;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 500px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        input[type="text"],
        input[type="date"],
        input[type="url"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; /* Important for padding */
            background-color: #fff; /* for select on dark mode */
            font-family: inherit; /* Ensure textarea matches */
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .columns {
            display: flex;
            gap: 1rem;
        }
        .columns > .form-group {
            flex: 1; /* Make columns equal width */
        }
        button {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 700;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 1rem;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Study Schedule Generator</h1>
        
        <div class="form-group">
            <label for="topic">What topic are you learning?</label>
            <input type="text" id="topic" placeholder="e.g., Python OOP">
        </div>
        
        <div class="form-group">
            <label for="startDate">When did you study it?</label>
            <input type="date" id="startDate">
        </div>

        <div class="form-group">
            <label for="schedule">Repetition Schedule (Intervals in Days)</label>
            <select id="schedule">
                <option value="1,3,7,14,30">Aggressive (For Exams: 1, 3, 7, 14, 30)</option>
                <option value="1,7,30,90">Long-Term (For Concepts: 1, 7, 30, 90)</option>
                <option value="1,2,4,8,16,32">Rapid Growth (Ebbinghaus: 1, 2, 4, 8, 16)</option>
                <option value="1,3,7,15" selected>Your Original (1, 3, 7, 15)</option>
            </select>
        </div>

        <div class="columns">
            <div class="form-group">
                <label for="time">Review Time (Optional)</label>
                <input type="time" id="time">
            </div>
            <div class="form-group">
                <label for="alarm">Alarm</label>
                <select id="alarm">
                    <option value="9am_day_of" selected>9:00 AM on day of</option>
                    <option value="15m_before">15 minutes before</option>
                    <option value="1h_before">1 hour before</option>
                    <option value="at_start">At time of event</option>
                    <option value="none">None</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="notes">Notes (Optional)</label>
            <textarea id="notes" placeholder="e.g., Focus on inheritance and polymorphism."></textarea>
        </div>

        <div class="form-group">
            <label for="url">Link to Materials (Optional)</label>
            <input type="url" id="url" placeholder="obsidian://open?vault=...">
        </div>

        <button id="generateBtn">Generate .ics File</button>

    </div>

    <script>
        // Set the default date to today
        document.getElementById('startDate').valueAsDate = new Date();

        /**
         * Formats a Date object into 'YYYYMMDDTHHMMSSZ' UTC format.
         */
        function formatUTC(date) {
            return date.toISOString().replace(/[-:.]/g, '').substring(0, 15) + 'Z';
        }

        /**
         * Formats a Date object into 'YYYYMMDD' for all-day events.
         */
        function formatDateAllDay(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        /**
         * Main function to generate the ICS content and trigger download.
         */
        function generateICS() {
            // Get all values from the form
            const topic = document.getElementById('topic').value;
            const startDateValue = document.getElementById('startDate').value;
            const scheduleValue = document.getElementById('schedule').value;
            const notes = document.getElementById('notes').value;
            const url = document.getElementById('url').value;
            const timeValue = document.getElementById('time').value; // NEW
            const alarmValue = document.getElementById('alarm').value; // NEW

            // Validation
            if (!topic || !startDateValue) {
                alert('Please fill in both the topic and the start date.');
                return;
            }

            const intervals = scheduleValue.split(',').map(Number);
            const startDate = new Date(startDateValue + 'T00:00:00');
            
            const nowStamp = formatUTC(new Date());
            const uniqueAppID = "spaced-rep-gen-" + Date.now();
            let icsEvents = [];

            intervals.forEach((days, index) => {
                let reviewDate = new Date(startDate.getTime());
                reviewDate.setDate(reviewDate.getDate() + days);

                // --- BUILD THE DESCRIPTION ---
                let description = [
                    'Spaced repetition review for "' + topic + '".',
                    'This is review #' + (index + 1) + ' of ' + intervals.length + ' (' + days + ' days).',
                    'Original study date: ' + startDate.toLocaleDateString()
                ];
                if (notes) {
                    description.push('\\n--- Notes ---');
                    description.push(notes.replace(/\n/g, '\\n'));
                }
                if (url) {
                    description.push('\\n--- Link ---');
                    description.push(url);
                }
                const finalDescription = description.join('\\n');
                
                // --- EVENT PARTS ---
                let eventParts = [
                    'BEGIN:VEVENT',
                    'UID:' + uniqueAppID + '-' + index + '@spaced-rep-gen.com',
                    'DTSTAMP:' + nowStamp,
                    'SUMMARY:Review #' + (index + 1) + ': ' + topic,
                    'DESCRIPTION:' + finalDescription
                ];

                let alarmTrigger = '';

                // --- TIME & TRANSPARENCY LOGIC ---
                if (timeValue) {
                    // SPECIFIC TIME EVENT
                    const [hours, minutes] = timeValue.split(':');
                    reviewDate.setHours(hours, minutes, 0, 0);

                    const endDate = new Date(reviewDate.getTime() + 60 * 60 * 1000); // 1 hour duration

                    eventParts.push('DTSTART:' + formatUTC(reviewDate));
                    eventParts.push('DTEND:' + formatUTC(endDate));
                    eventParts.push('TRANSP:OPAQUE'); // Show as "Busy"

                    // ALARM LOGIC (Specific Time)
                    switch (alarmValue) {
                        case '15m_before':
                            alarmTrigger = 'TRIGGER:-PT15M';
                            break;
                        case '1h_before':
                            alarmTrigger = 'TRIGGER:-PT1H';
                            break;
                        case 'at_start':
                            alarmTrigger = 'TRIGGER:-PT0M';
                            break;
                        case '9am_day_of':
                            let alarmTime = new Date(reviewDate.getTime());
                            alarmTime.setHours(9, 0, 0, 0);
                            alarmTrigger = 'TRIGGER;VALUE=DATE-TIME:' + formatUTC(alarmTime);
                            break;
                        case 'none':
                            break; // alarmTrigger remains empty
                    }

                } else {
                    // ALL-DAY EVENT
                    let nextDay = new Date(reviewDate.getTime());
                    nextDay.setDate(nextDay.getDate() + 1);
                    
                    eventParts.push('DTSTART;VALUE=DATE:' + formatDateAllDay(reviewDate));
                    eventParts.push('DTEND;VALUE=DATE:' + formatDateAllDay(nextDay));
                    eventParts.push('TRANSP:TRANSPARENT'); // Show as "Free"

                    // ALARM LOGIC (All-Day)
                    // For all-day, all alarms (except none) default to 9 AM on the day.
                    if (alarmValue !== 'none') {
                        alarmTrigger = 'TRIGGER;RELATED=START:PT9H'; // 9:00 AM
                    }
                }

                // --- ADD ALARM IF NEEDED ---
                if (alarmTrigger) {
                    eventParts.push(
                        'BEGIN:VALARM',
                        'ACTION:DISPLAY',
                        'DESCRIPTION:Time to review ' + topic,
                        alarmTrigger,
                        'END:VALARM'
                    );
                }

                eventParts.push('END:VEVENT');
                icsEvents.push(eventParts.join('\r\n'));
            });

            // Create the full calendar file content
            const icsFileContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//SpacedRepApp/v4.0//EN',
                ...icsEvents,
                'END:VCALENDAR'
            ].join('\r\n');

            // Trigger the download
            download(topic.replace(/[^a-z0-9]/gi, '_') + '_schedule.ics', icsFileContent);
        }
        
        /**
         * Triggers a browser download of a text file.
         */
        function download(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/calendar;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

    </script>
</body>
</html>
